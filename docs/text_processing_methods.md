# テキストの処理方法

data/input.txt のテキストを以下の手順で処理する。

1. テキストの行分割とトリム
2. 単語エントリの抽出
3. 単語エントリごとの本文の処理
4. 定義文の処理
5. 最終データの出力

それぞれの手順について以下に詳細を記述する。

## 1. テキストの行分割とトリム

以下の手順に従って、テキスト全体の単一の文字列から、文字列の配列に変換する。

1. テキストを行に分割する
2. 各行の前後の空白を削除する
3. 空白行を削除する

## 2. 単語エントリの抽出

次に、各行を集計して、以下の単語エントリのデータを抽出する。
単語エントリの型は以下のとおり。

```ts
interface WordEntry {
  number: string;
  name: string;
  contentLines: string;
}
```

単語エントリは以下の手順で抽出する。

1. 単語番号の行を検出する

- 単語番号はの形式は小数値である
- "3.x" の形式で、行頭に数字 "3" があり、その後に小数点と数字が続く
- 例： "3.1", "3.2", "3.3" など

2. 単語名の行を検出する

- 単語名は単語番号の次の行である
- この行は必ず存在する

3. 本文の行を検出する

- 単語名の次の行から、次の単語番号の行までの間の全ての行
- 本文は複数行にまたがることがある
- 本文の複数行の処理は後続処理で行うため、ここでは単純に配列に追加する

## 3. 単語エントリごとの本文の処理

次に、単語エントリごとの本文の処理を行う。
前の処理で複数行の文字列として抽出された本文を処理して、以下のスキーマに変換する。

```ts
interface WordContent {
  definition: string;
  alias?: string;
  confer?: string;
  example?: string;
  note?: string;
}
```

本文の行は以下のパターンがある。これらを場合分けして処理する。

1. 特別なプレフィックスを持つ行

- "1. ", "cf. ", "EXAMPLE: ", "Note 1 to entry: " で開始する行は、特別な行として扱う
- これらが見つかった場合は、新規のセクションが開始したものとして扱う
- これらは以下の専用フィールドに保存する。
  - "1. " は "definition" フィールドに保存
  - "cf. " は "confer" フィールドに保存
  - "EXAMPLE: " は "example" フィールドに保存
  - "Note 1 to entry: " は "note" フィールドに保存
- "1. " についてはプレフィックスも本文に含める。それ以外はプレフィックスを削除して本文に保存する。

2. Alias の行

- 最初の特別なプレフィックスが見つかるまでの間にある行は、Alias の行である
- 単語エントリによっては存在しないものがある
- 複数行存在する場合もある。複数行の場合は、スペースで結合する
- Alias は "alias" フィールドに保存する

3. その他の行

- 上記以外の行は、文章の途中ものとして扱う。これらは、前の行とスペースで結合する

## 4. 定義文の処理

上記処理で取得した `WordContent.definition` の文字列を処理して、以下のデータに変換する。

```ts
type WordDefinition = {
  text: string;
  reference?: string;
}[];
```

### 定義文の形式

定義文は、"1. " から始まる。単一の定義のみの場合もあれば、複数の定義がある場合もある。
複数の定義がある場合は、" 2. " のように、前の単語のスペースの後に数字とピリオドとカンマがある。
定義の最後には参照元となった文献の記載がある場合がある。この参照元は `[]` で囲まれた文字列で表現されている。

### 処理手順

上記の形式を踏まえて、以下の手順で処理をする。

1. 定義文全体を、ナンバリングされた定義に分割する

- "1. " で開始するもの
- " x. " で開始するもの（xは整数値）

2. 各定義のナンバリングとプレフィックスを削除する

- "1. " で開始する部分のプレフィックスを削除する
- " x. " で開始する部分のプレフィックスを削除する（xは整数値）
- プレフィックス部分は `WordDefinition.text` に含めない

3. 各定義の参照を抽出する

- 定義の文字列のうち "[]" で囲まれた部分のみを抽出する

## 5. 最終データの出力

上記で処理した `WordEntry`, `WordContent`, `WordDefinition` を合成して、最終データに変換する。
最終的な出力 `Output` は以下となる。

```ts
type Output = Word[];

interface Word {
  number: WordEntry["number"];
  name: WordEntry["name"];
  alias?: string;
  definitions: WordDefinition[];
  confer?: string;
  example?: string;
  note?: string;
}
```
